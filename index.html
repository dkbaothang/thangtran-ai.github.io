<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>üé§ TH·∫ÆNG TR·∫¶N KARAOKE PREMIUM</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: black;
      overflow: hidden;
      color: white;
    }

    /* ===== TOP LEFT LOGO + QR ===== */
    #topHeader {
      position: fixed;
      top: 10px;
      left: 12px;
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: bold;
    }

    #topHeader a {
      color: cyan;
      text-decoration: none;
      text-shadow: 0 0 10px cyan;
    }

    .qr-btn {
      cursor: pointer;
      font-size: 13px;
      padding: 5px 12px;
      border-radius: 14px;
      border: 1px solid cyan;
      box-shadow: 0 0 12px cyan;
      background: rgba(0,255,255,0.2);
    }

    /* ===== VIDEO FULLSCREEN ===== */
    iframe {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      border: none;
      z-index: 1;
    }

    /* ===== LYRICS OVERLAY ===== */
    #lyricsBox {
      position: fixed;
      bottom: 15%;
      width: 100%;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 20px magenta;
      z-index: 50;
    }

    /* ===== POPUP PLAYLIST BUTTON ===== */
    #btnPlaylist {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 200;
      background: rgba(0,255,255,0.2);
      border: 1px solid cyan;
      padding: 14px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 0 20px cyan;
    }

    /* ===== PLAYLIST SLIDE PANEL ===== */
    #popup {
      position: fixed;
      top: 0;
      right: -420px;
      width: 380px;
      height: 100vh;
      background: rgba(10,10,30,0.96);
      z-index: 300;
      transition: 0.35s;
      padding: 15px;
      overflow-y: auto;
      border-left: 2px solid cyan;
    }

    #popup.active {
      right: 0;
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: none;
      outline: none;
      margin-top: 10px;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 12px;
      margin-top: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .btnSearch { background: red; color: white; }
    .btnVoice  { background: #333; color: white; }
    .btnShare  { background: cyan; color: black; }

    .song {
      padding: 10px;
      margin: 10px 0;
      border-radius: 12px;
      cursor: pointer;
      background: rgba(255,255,255,0.06);
    }

    .song:hover {
      background: rgba(0,255,255,0.2);
    }

    /* MOBILE */
    @media(max-width:768px){
      #popup { width: 100%; }
      #lyricsBox { font-size: 20px; }
    }
  </style>
</head>

<body>

<!-- TOP HEADER -->
<div id="topHeader">
  <span onclick="toggleQR()" class="qr-btn">üìå QR</span>
  <a href="https://dkbaothang.github.io/thangtran-ai.github.io/" target="_blank">
    üé§ TH·∫ÆNG TR·∫¶N KARAOKE
  </a>
</div>

<!-- VIDEO -->
<iframe id="player"></iframe>

<!-- LYRICS -->
<div id="lyricsBox">üé∂ Ch·ªçn b√†i ƒë·ªÉ h√°t Karaoke...</div>

<!-- PLAYLIST BUTTON -->
<div id="btnPlaylist" onclick="togglePopup()">üìå</div>

<!-- PLAYLIST POPUP -->
<div id="popup">
  <h2 style="color:cyan;">üé∂ Playlist Premium</h2>

  <input id="query" placeholder="T√¨m b√†i karaoke...">

  <button class="btnSearch" onclick="search()">üîç Search</button>
  <button class="btnVoice" onclick="voiceSearch()">üéô Voice</button>

  <button class="btnShare" onclick="shareApp()">üì§ Share Zalo/Facebook</button>

  <hr style="margin:15px 0;">

  <div id="results"></div>
</div>

<!-- QR POPUP -->
<div id="qrPopup" style="
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.88);
  z-index:9999;
  text-align:center;
  padding-top:90px;">

  <h2 style="color:cyan;">üìå Qu√©t QR ƒë·ªÉ h√°t ngay</h2>

  <img
    src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=https://dkbaothang.github.io/thangtran-ai.github.io/"
    style="margin-top:25px;border-radius:20px;box-shadow:0 0 25px cyan;"
  >

  <button onclick="toggleQR()"
    style="margin-top:30px;padding:12px 28px;
    border:none;border-radius:20px;
    background:red;color:white;font-weight:bold;">
    ‚ùå ƒê√≥ng
  </button>
</div>

<script>
  const WORKER_URL =
    "https://thang-tran-karaoke-ai.thangtran.workers.dev/search?q=";

  let playlist = [];
  let currentIndex = 0;
  let lrcLines = [];
  let syncTimer = null;

  /* Popup Playlist */
  function togglePopup() {
    document.getElementById("popup").classList.toggle("active");
  }

  /* QR Popup */
  function toggleQR() {
    const p = document.getElementById("qrPopup");
    p.style.display = (p.style.display === "block") ? "none" : "block";
  }

  /* Share App */
  function shareApp() {
    const url = "https://dkbaothang.github.io/thangtran-ai.github.io/";
    navigator.share
      ? navigator.share({ title: "TH·∫ÆNG TR·∫¶N KARAOKE", url })
      : alert("Copy link chia s·∫ª:\n" + url);
  }

  /* Search YouTube */
  async function search() {
    const q = document.getElementById("query").value;
    const box = document.getElementById("results");
    box.innerHTML = "‚è≥ ƒêang t√¨m...";

    const res = await fetch(WORKER_URL + encodeURIComponent(q));
    const data = await res.json();

    playlist = [];
    box.innerHTML = "";

    data.items.forEach((item, i) => {
      const id = item.id.videoId;
      const title = item.snippet.title;

      playlist.push({ id, title });

      const div = document.createElement("div");
      div.className = "song";
      div.innerText = "üéµ " + title;
      div.onclick = () => playSong(i);

      box.appendChild(div);
    });
  }

  /* Play Song */
  function playSong(index) {
    currentIndex = index;
    const song = playlist[index];

    document.getElementById("player").src =
      "https://www.youtube.com/embed/" + song.id + "?autoplay=1&controls=0";

    document.getElementById("lyricsBox").innerText =
      "üé§ ƒêang h√°t: " + song.title;

    fetchLyricsLRCLib(song.title);

    togglePopup();
  }

  /* Auto Next (demo timer ~180s) */
  function autoNext() {
    setTimeout(() => {
      if (currentIndex < playlist.length - 1) {
        playSong(currentIndex + 1);
      }
    }, 180000);
  }

  /* Voice Search */
  function voiceSearch() {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("Kh√¥ng h·ªó tr·ª£ Voice!");

    const recog = new SpeechRecognition();
    recog.lang = "vi-VN";
    recog.onresult = e => {
      document.getElementById("query").value = e.results[0][0].transcript;
      search();
    };
    recog.start();
  }

  /* ===== LYRICS ONLINE LRCLib ===== */
  async function fetchLyricsLRCLib(title) {
    try {
      const clean = title.split("|")[0].trim();
      const url = "https://lrclib.net/api/search?q=" + encodeURIComponent(clean);

      const res = await fetch(url);
      const data = await res.json();

      if (!data || data.length === 0) return;

      const lrc = data[0].syncedLyrics;
      if (!lrc) return;

      parseLRC(lrc);
      startSync();
    } catch(e){}
  }

  /* Parse LRC */
  function parseLRC(lrcText) {
    lrcLines = lrcText.split("\n").map(line => {
      const match = line.match(/\[(\d+):(\d+\.\d+)\](.*)/);
      if (!match) return null;
      return {
        time: parseInt(match[1])*60 + parseFloat(match[2]),
        text: match[3]
      };
    }).filter(x=>x);
  }

  /* Start Karaoke Sync (demo) */
  function startSync() {
    let start = Date.now();

    if(syncTimer) clearInterval(syncTimer);

    syncTimer = setInterval(() => {
      let t = (Date.now() - start)/1000;
      let line = lrcLines.findLast(l => l.time <= t);
      if(line) document.getElementById("lyricsBox").innerText = line.text;
    }, 300);
  }
</script>

</body>
</html>
